package com.scan.cve;

import com.jayway.jsonpath.Configuration;
import com.jayway.jsonpath.DocumentContext;
import com.jayway.jsonpath.Filter;
import com.jayway.jsonpath.JsonPath;
import com.jayway.jsonpath.Predicate;
import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.Map;
import java.util.TreeSet;

import static com.jayway.jsonpath.Criteria.where;

public class ParserMain {

    private final Logger logger = LoggerFactory.getLogger(ParserMain.class);

    public void readJson() {

    }

    public void processJsonFile(String fileName) {
      logger.info("processing file: {}", fileName);
        try(InputStream inp = this.getClass().getClassLoader().getResourceAsStream(fileName)) {
            if(inp == null) {
                throw new IllegalStateException("Failed to read file " + fileName);
            }
            final String json = IOUtils.toString(inp, StandardCharsets.UTF_8);
            //logger.debug("JSON file: " + json);
            Object document = Configuration.defaultConfiguration().jsonProvider().parse(json);
            final DocumentContext context = JsonPath.parse(document);
            Predicate packagePathFilter = new Predicate() {
                @Override
                public boolean apply(PredicateContext ctx) {
                    final Map<String,String> item = ctx.item(Map.class);
                    return item.getOrDefault("package_path","").contains("/opt/storm");
                }
            };
            final List<String> pkglist = context.read("$.[?].nvd_data[*].id",packagePathFilter);
            TreeSet<String> treeSet = new TreeSet<>(pkglist);
            treeSet.forEach(id -> System.out.println(id));

        } catch (IOException e) {
            logger.error("Exception occurred while processing file: " + fileName + " : " + e.getMessage(), e);
        }
    }

    public static void main(String[] args) {
       ParserMain cveSort = new ParserMain();
       cveSort.processJsonFile("storm-cve.json");

    }

}
